# 配置系统说明文档

## 概述

本系统有两个独立的配置文件：

1. **Configuration.json** - 业务配置（物品清单）
2. **user_settings.json** - 用户检测参数配置

## 配置文件说明

### 1. Configuration.json (业务配置)

**位置**: `config/Configuration.json`

**用途**: 定义 storage box 中应该包含的物品清单（class1-class9）

**示例**:
```json
{
  "class0": {
    "name": "Storage tray",
    "contains": {
      "class1": { "name": "main unit", "quantity": 1 },
      "class2": { "name": "fabric bag", "quantity": 1 },
      "class3": { "name": "shaver", "quantity": 1 },
      "class4": { "name": "engraving knife", "quantity": 1 },
      "class5": { "name": "nose hair trimmer", "quantity": 1 },
      "class6": { "name": "comb", "quantity": 1 },
      "class7": { "name": "brush", "quantity": 1 },
      "class8": { "name": "charger", "quantity": 1 },
      "class9": { "name": "charging cable", "quantity": 1 }
    }
  }
}
```

**修改方式**:
1. 用文本编辑器打开 `config/Configuration.json`
2. 修改物品的 `name` 或 `quantity`
3. **保存文件**
4. 启动或重新启动检测 - 系统会自动加载最新的配置

**生效时间**: 下次启动检测时立即生效（无需重启程序）

---

### 2. user_settings.json (检测参数)

**位置**: `config/user_settings.json`

**用途**: 保存用户在 Web 界面上设置的检测参数

**示例**:
```json
{
    "save_video": "False",
    "output_dir": "run",
    "flip": "-1",
    "alert_display_time": "10",
    "light_port": "COM10",
    "log_level": "INFO",
    "video": "data\\111.mp4",
    "output_name": "web_record",
    "fps": "10",
    "conf_threshold": "0.5",
    "sort_max_age": "60",
    "sort_min_hits": "30",
    "sort_iou_threshold": "0.2"
}
```

**参数说明**:
| 参数 | 说明 | 示例值 |
|-----|------|-------|
| video | 视频源（摄像头ID或文件路径） | `0` (摄像头) 或 `data/video.mp4` |
| fps | 目标帧率 | `30` |
| conf_threshold | 检测置信度 | `0.5` |
| sort_max_age | SORT 追踪器最大年龄 | `60` |
| sort_min_hits | SORT 追踪器最小帧数 | `30` |
| sort_iou_threshold | SORT IoU 阈值 | `0.2` |
| light_port | 灯光控制串口 | `COM3` 或 `COM10` |
| flip | 画面翻转 (0=不翻转, -1=垂直翻转, 1=水平翻转) | `0` |
| alert_display_time | 报警显示时长（帧数） | `10` |
| output_dir | 输出目录 | `run` 或 `output` |
| save_video | 是否保存视频 | `False` 或 `True` |

**修改方式**:
- 通过 Web 界面修改参数后，点击"启动"会自动保存
- 或手动编辑此文件
- 修改会在下次启动检测时生效

---

## 加载流程

### 系统启动时序

```
1. 用户在 Web 界面设置参数并点击"启动"
   ↓
2. app.py 的 /start_detection 接口被调用
   - 保存参数到 user_settings.json
   - 创建 DetectorThread
   ↓
3. DetectorThread 初始化
   - 创建 VideoProcessor
   ↓
4. VideoProcessor 初始化 [关键步骤]
   - 强制重新加载 Configuration.json (force_reload=True)
   - 打印物品清单到日志
   - 创建 InventoryManager (使用新加载的配置)
   ↓
5. 检测开始
   - 使用最新的物品清单监控
```

### 缓存机制

- **Configuration.json**: 使用文件修改时间戳自动检测变化
  - 第一次加载：读取文件并缓存
  - 后续加载：比较时间戳，如果相同使用缓存（性能优化）
  - 文件修改后：下次启动时自动重新加载
  
- **user_settings.json**: 每次都重新读取（无缓存）

---

## 常见问题排查

### 问题 1: 修改了 Configuration.json，但检测时没有生效

**解决方案**:
1. ✓ 确保已保存文件
2. ✓ 停止当前检测（如果在运行）
3. ✓ 在 Web 界面点击"启动"重新开始检测
4. ✓ 查看控制台输出，应该能看到：
   ```
   ✓ [重新加载配置] .../config/Configuration.json
     规范化后的物品列表: ['class1', 'class2', ...]
   ```

### 问题 2: Configuration.json 格式错误

**错误症状**:
```
❌ 配置文件格式错误: ...
❌ 严重警告: 配置文件加载失败
```

**排查方法**:
1. 在线 JSON 验证工具验证文件格式
2. 确保所有属性名用双引号
3. 确保没有多余逗号
4. 运行诊断脚本：`python scripts/check_config.py`

### 问题 3: 文件路径找不到

**错误症状**:
```
❌ 配置文件不存在: ...
```

**排查方法**:
1. 确保 `config/` 目录存在
2. 确保 `Configuration.json` 在 `config/` 目录中
3. 运行诊断脚本：`python scripts/check_config.py`

---

## 诊断工具

### 运行配置诊断

```bash
python scripts/check_config.py
```

**检查内容**:
- ✓ 配置文件是否存在
- ✓ Configuration.json 是否可以加载
- ✓ user_settings.json 是否可以加载
- ✓ 缓存机制是否正常

---

## 代码位置参考

### 配置加载逻辑

| 文件 | 函数 | 功能 |
|------|------|------|
| `utils/config_loader.py` | `load_spec()` | 加载并验证 Configuration.json |
| `utils/config_loader.py` | `load_user_settings()` | 加载用户设置 |
| `utils/config_loader.py` | `save_user_settings()` | 保存用户设置 |
| `modules/video_processor.py` | `__init__()` | VideoProcessor 初始化（加载配置的地方） |
| `modules/detector_thread.py` | `__init__()` | 检测线程初始化 |
| `app.py` | `start_detection()` | Web API - 启动检测 |
| `app.py` | `get_user_config()` | Web API - 获取用户配置 |

### 关键调用链

```
app.py:/start_detection
    └─> detector_thread.DetectorThread.__init__
            └─> video_processor.VideoProcessor.__init__
                    └─> config_loader.load_spec('Configuration.json', force_reload=True)
                            ├─> 读取文件
                            ├─> 验证格式
                            ├─> 规范化物品清单
                            └─> 返回配置
```

---

## 最佳实践

### ✓ 推荐做法

1. **定期备份** Configuration.json
   ```bash
   copy config\Configuration.json config\Configuration.json.backup
   ```

2. **使用诊断工具** 验证配置
   ```bash
   python scripts/check_config.py
   ```

3. **查看日志** 确认加载状态
   - 启动检测后，查看控制台输出
   - 应该能看到"[重新加载配置]"的消息

4. **增量修改** 避免一次修改过多
   - 修改一项后测试
   - 确认生效再修改下一项

### ❌ 不推荐做法

1. ✗ 在检测运行中修改 Configuration.json
   - 应该停止后再修改
   
2. ✗ 手动编辑 user_settings.json
   - 应该通过 Web 界面修改

3. ✗ 删除或移动 Configuration.json
   - 系统依赖此文件正常运行

4. ✗ 修改后立即启动而不保存
   - 务必保存文件后再启动

---

## 调试技巧

### 查看详细日志

启动检测后，在控制台观察以下日志：

```
[重新加载配置] .../config/Configuration.json
  文件修改时间: 1726234567.890
  规范化后的物品列表: ['class1', 'class2', 'class3', 'class4', 'class5', 'class6', 'class7', 'class8', 'class9']
```

### 强制重新加载

如果需要强制重新加载配置（绕过缓存）：

1. 停止检测
2. 删除或修改 Configuration.json 的修改时间
3. 重新启动检测

或在代码中直接调用：
```python
from utils.config_loader import load_spec
spec = load_spec('Configuration.json', force_reload=True)
```

---

## 总结

| 场景 | 修改文件 | 生效时间 |
|------|--------|--------|
| 修改物品清单 | Configuration.json | 下次启动检测 |
| 修改检测参数（FPS、置信度等） | Web 界面 → 自动保存到 user_settings.json | 下次启动检测 |
| 修改灯光串口 | Web 界面 | 下次启动检测 |
| 修改输出目录 | Web 界面 | 下次启动检测 |

**核心原则**: Configuration.json 修改后，下次启动检测时会自动加载最新配置。
